apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: team-apps
  namespace: argocd
spec:
  # Use matrix generator to combine Git directories (teams) × environments (dev/prod)
  generators:
  - matrix:
      generators:
      # Generator 1: Discover team apps from Git directories
      - git:
          repoURL: https://github.com/natosullivan/cuddly-disco.git
          revision: HEAD
          directories:
          - path: k8s/team-apps/*

      # Generator 2: Define target environments with version support
      - list:
          elements:
          # Dev cluster - v1 (default version)
          - cluster: kind-dev
            environment: dev
            version: v1
            valuesFile: values-dev.yaml
          # Dev cluster - v2 (header-based routing)
          - cluster: kind-dev
            environment: dev
            version: v2
            valuesFile: values-dev-v2.yaml
          # Prod cluster - v1 only (for now)
          - cluster: kind-prod
            environment: prod
            version: v1
            valuesFile: values-prod.yaml

  # Template to generate Applications for each team × environment × version combination
  template:
    metadata:
      name: '{{path.basename}}-{{environment}}-{{version}}'
      labels:
        team: '{{path.basename}}'
        environment: '{{environment}}'
        version: '{{version}}'
    spec:
      project: default

      source:
        repoURL: https://github.com/natosullivan/cuddly-disco.git
        # Use targetRevision from config.yaml or default to HEAD
        targetRevision: HEAD
        path: '{{path}}'
        helm:
          valueFiles:
          - values.yaml
          - '{{valuesFile}}'

      destination:
        name: '{{cluster}}'
        namespace: '{{path.basename}}'

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
